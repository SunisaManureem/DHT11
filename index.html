<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Temperature & Humidity Monitor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0f2235; --bg2:#3c5570; --bg3:#a9b6c4;
      --text:#f3f7fd; --muted:rgba(255,255,255,.85);
      --panel:rgba(255,255,255,.12); --panel-2:rgba(255,255,255,.16);
      --panel-card:#eef1f5; --panel-tint:rgba(0,0,0,.06);
      --border:rgba(255,255,255,.24); --card-border:rgba(0,0,0,.08);
      --shadow:0 28px 60px rgba(8,18,32,.35);
      --lineT:#ffb870; --lineH:#7db9ff; --grid:rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family:'Poppins',system-ui,Segoe UI,Arial,sans-serif;
      background:
        radial-gradient(1200px 900px at 100% -10%, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 55%, var(--bg3) 100%);
      display:flex; align-items:center; justify-content:center; padding:28px;
    }
    .board{width:min(1080px,96vw); border-radius:28px; background:rgba(255,255,255,.10);
      backdrop-filter: blur(18px) saturate(125%); -webkit-backdrop-filter: blur(18px) saturate(125%);
      border:1px solid var(--border); box-shadow:var(--shadow); overflow:hidden; position:relative;}
    .bar{display:flex; align-items:center; justify-content:space-between;
      padding:18px 22px; border-bottom:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0));}
    .place{font-weight:800; font-size:26px; letter-spacing:.2px; text-shadow:0 1px 0 rgba(0,0,0,.28)}
    .chip{font-size:14px; font-weight:700; color:#1c2d45; background:#ffffff; border:1px solid rgba(0,0,0,.06);
      padding:8px 14px; border-radius:999px; box-shadow:0 10px 18px rgba(0,0,0,.18); min-width:96px; text-align:center;}

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; padding:18px;}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg, #ffffff, #f0f3f7); border:1px solid var(--card-border);
      border-radius:22px; box-shadow:0 12px 28px rgba(0,0,0,.16); padding:22px;}

    .main{display:grid; grid-template-columns:88px 1fr; gap:18px; align-items:center;}
    .icon{width:72px;height:72px;border-radius:18px; display:flex;align-items:center;justify-content:center;font-size:38px;
      background:linear-gradient(180deg, #fff4cf, #ffe39a); border:1px solid rgba(0,0,0,.06);
      box-shadow: inset 0 10px 20px rgba(255,255,255,.65), 0 6px 16px rgba(0,0,0,.18); color:#e7b100;}
    .tempRow{display:flex;align-items:baseline;gap:10px}
    #temperature-value{font-size: clamp(44px, 9vw, 88px); line-height:1; font-weight:800;
      color:#2b3c54; letter-spacing:.5px; text-shadow:0 2px 0 rgba(0,0,0,.10);}
    .unit{font-weight:700;color:#5f738f}
    .subtext{margin-top:2px;color:#5f738f;font-weight:700}

    .side{display:flex;flex-direction:column;gap:18px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .label{font-weight:800;color:#2b3c54;display:flex;align-items:center;gap:8px}

    /* ===== Donut (เลขอยู่บน) ===== */
    .donut{--p:0; width:128px; height:128px; border-radius:50%;
      background: conic-gradient(var(--lineH) calc(var(--p)*1%), #e3e9f1 0),
                  radial-gradient(closest-side, #ffffff 72%, transparent 74%, transparent 100%);
      border:1px solid rgba(0,0,0,.06); display:flex;align-items:center;justify-content:center;
      box-shadow: inset 0 10px 24px rgba(255,255,255,.6), 0 8px 18px rgba(0,0,0,.12);
      transition: background .7s cubic-bezier(.2,.7,.2,1); position:relative;}
    .donut:after{
      content:""; position:absolute; inset:12px; border-radius:50%;
      background:linear-gradient(180deg,#ffffff,#eef2f7); border:1px solid rgba(0,0,0,.04);
      z-index:0; pointer-events:none;
    }
    .donut .num{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-size:34px; font-weight:800; color:#2b3c54; z-index:1;
    }

    .chart-panel{grid-column:1 / -1;}
    .chart-card{position:relative; overflow:hidden}
    .legend{position:absolute; top:12px; right:14px; display:flex; gap:10px; font-size:12px; color:#5f738f; font-weight:700;
      background:#e6ebf2; border:1px solid rgba(0,0,0,.06); border-radius:999px; padding:6px 10px; box-shadow:0 6px 14px rgba(0,0,0,.08);}
    .dot{width:10px;height:10px;border-radius:50%;}
    .t{background:var(--lineT)} .h{background:var(--lineH)}
    canvas{width:100%; height:340px; display:block}

    .status-wrap{display:flex; justify-content:center; margin-top:14px}
    #status-message{color:#2b3c54; background:#ffffff; border:1px solid rgba(0,0,0,.06);
      border-radius:999px; padding:10px 18px; font-weight:800; box-shadow:0 10px 20px rgba(0,0,0,.12);}

    /* ===== ตารางประวัติ (เพิ่มใหม่) ===== */
    .history{grid-column:1 / -1;}
    .table-wrap{overflow:auto; max-height:360px; border:1px solid var(--card-border); border-radius:16px; background:#fff;}
    table{width:100%; border-collapse:collapse; font-family:'Poppins',system-ui,Arial,sans-serif; color:#2b3c54;}
    thead th{position:sticky; top:0; background:#eef3fb; font-weight:800; font-size:14px; text-align:left; padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06);}
    tbody td{padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06); font-weight:600;}
    tbody tr:nth-child(odd){background:#fafcff;}
  </style>
</head>
<body>
  <div class="board">
    <div class="bar">
      <div class="place">Temperature & Humidity Dashboard</div>
      <div class="chip" id="clock">--:--:--</div>
    </div>

    <div class="grid">
      <section class="card main">
        <div class="icon">☀️</div>
        <div>
          <div class="tempRow">
            <div id="temperature-value">--</div>
            <div class="unit">°C</div>
          </div>
          <div class="subtext">Temperature</div>
        </div>
      </section>

      <section class="side">
        <div class="card">
          <div class="row">
            <div class="label">Humidity</div>
            <div class="donut" id="humidity-donut" style="--p:0">
              <span class="num" id="humidity-value">--%</span>
            </div>
          </div>
        </div>

        <div class="card status-wrap">
          <div id="status-message">Connecting...</div>
        </div>
      </section>

      <section class="card chart-panel chart-card">
        <div class="legend">
          <span style="display:flex;align-items:center;gap:6px"><span class="dot t"></span>Temp</span>
          <span style="display:flex;align-items:center;gap:6px"><span class="dot h"></span>Humidity</span>
        </div>
        <canvas id="chart"></canvas>
      </section>

      <!-- ตารางประวัติย้อนหลัง (ใหม่) -->
      <section class="card history">
        <h3 style="margin:0 0 10px 0; color:#2b3c54">ประวัติย้อนหลัง (MongoDB)</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>เวลา</th>
                <th>อุณหภูมิ (°C)</th>
                <th>ความชื้น (%RH)</th>
              </tr>
            </thead>
            <tbody id="history-body">
              <!-- rows will be injected here -->
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
    /* ===== Backend polling & chart logic ===== */
    const BACKEND_BASE = "https://dht11-2gtd.onrender.com";
    const MAX_POINTS = 60;
    const series = { t: [], h: [], ts: [] };

    function setText(id, value){ const el = document.getElementById(id); if (el) el.textContent = value; }

    // realtime clock
    function updateClock(){
      const el = document.getElementById('clock'); if (!el) return;
      el.textContent = new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
    }
    updateClock(); setInterval(updateClock, 1000);

    // canvas
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    let dpi = 1;

    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      dpi = window.devicePixelRatio || 1;
      canvas.width  = Math.round(rect.width  * dpi);
      canvas.height = Math.round(rect.height * dpi);
      drawChart(1);
    }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    function lerp(a,b,t){ return a + (b-a)*t; }
    function niceRange(min, max){
      if (min === max){ min -= 1; max += 1; }
      const pad = (max - min) * 0.15;
      return [Math.floor(min - pad), Math.ceil(max + pad)];
    }

    let anim = { fromT:[], toT:[], fromH:[], toH:[], start:0, dur:800 };
    function scheduleAnimation(){
      anim.fromT = anim.toT.slice(); anim.fromH = anim.toH.slice();
      anim.toT = series.t.slice();   anim.toH  = series.h.slice();
      anim.start = performance.now(); requestAnimationFrame(tick);
    }
    function tick(now){ const p=Math.min(1,(now-anim.start)/anim.dur); drawChart(p); if(p<1) requestAnimationFrame(tick); }

    function drawChart(progress=1){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      const leftPad  = 46 * dpi, rightPad = 16 * dpi, topPad = 16 * dpi, botPad = 42 * dpi;
      const plotW = w - leftPad - rightPad;
      const plotH = h - topPad - botPad;

      const hasData = series.t.length >= 2;
      const minT = hasData ? Math.min(...series.t) : 20;
      const maxT = hasData ? Math.max(...series.t) : 30;
      const minH = hasData ? Math.min(...series.h) : 40;
      const maxH = hasData ? Math.max(...series.h) : 80;

      const [yMin,yMax] = niceRange(Math.min(minT,minH), Math.max(maxT,maxH));
      const N = Math.max(series.t.length, 2);

      const xAt = i => leftPad + (i/(N-1))*plotW;
      const yAt = v => topPad + (1 - (v - yMin)/(yMax - yMin))*plotH;

      // grid
      const gx=8, gy=5;
      ctx.save();
      ctx.strokeStyle = 'rgba(0,0,0,.10)'; ctx.lineWidth = 1*dpi;
      for(let i=0;i<=gx;i++){ const x = leftPad + (plotW/gx)*i; ctx.beginPath(); ctx.moveTo(x,topPad); ctx.lineTo(x,topPad+plotH); ctx.stroke(); }
      for(let i=0;i<=gy;i++){ const y = topPad + (plotH/gy)*i; ctx.beginPath(); ctx.moveTo(leftPad,y); ctx.lineTo(leftPad+plotW,y); ctx.stroke(); }
      ctx.restore();

      // Y ticks
      ctx.save();
      ctx.fillStyle='#5f738f'; ctx.textAlign='right'; ctx.textBaseline='middle';
      ctx.font=`${12*dpi}px Poppins, sans-serif`;
      for(let i=0;i<=gy;i++){
        const y = topPad + (plotH/gy)*i;
        const val = yMax - (yMax - yMin) * (i/gy);
        ctx.fillText(val.toFixed(0), leftPad - 6*dpi, y);
      }
      ctx.restore();

      // X ticks
      ctx.save();
      ctx.fillStyle='#5f738f'; ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.font=`${12*dpi}px Poppins, sans-serif`;
      const fmt = ts => new Date(ts).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',hour12:false});
      if(hasData){
        const minTs = series.ts[0], maxTs = series.ts[series.ts.length-1];
        for(let i=0;i<=gx;i++){ const t = minTs + (maxTs-minTs)*(i/gx); ctx.fillText(fmt(t), leftPad + (plotW/gx)*i, topPad+plotH+8*dpi); }
      }else{
        const now = Date.now(); for(let i=0;i<=gx;i++){ ctx.fillText(fmt(now), leftPad + (plotW/gx)*i, topPad+plotH+8*dpi); }
      }
      ctx.restore();

      // Axis titles
      ctx.save();
      ctx.fillStyle='#2b3c54'; ctx.font=`${12*dpi}px Poppins, sans-serif`;
      ctx.translate(12*dpi, topPad + plotH/2); ctx.rotate(-Math.PI/2); ctx.textAlign='center';
      ctx.fillText('Temp (°C) / Humidity (%RH)', 0, 0);
      ctx.restore();

      ctx.save();
      ctx.fillStyle='#2b3c54'; ctx.font=`${12*dpi}px Poppins, sans-serif`; ctx.textAlign='center'; ctx.textBaseline='bottom';
      ctx.fillText('Time (Real-Time)', leftPad + plotW/2, h - 6*dpi);
      ctx.restore();

      if (!hasData) return;

      const sample = (a,b,i)=>lerp(a[i] ?? b[i], b[i], progress);

      // temp line
      ctx.save(); ctx.lineWidth=3*dpi; ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--lineT').trim();
      ctx.beginPath(); for(let i=0;i<N;i++){ const x=xAt(i), y=yAt(sample(anim.fromT,anim.toT,i)); i?ctx.lineTo(x,y):ctx.moveTo(x,y); } ctx.stroke(); ctx.restore();

      // humidity line
      ctx.save(); ctx.lineWidth=3*dpi; ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--lineH').trim();
      ctx.beginPath(); for(let i=0;i<N;i++){ const x=xAt(i), y=yAt(sample(anim.fromH,anim.toH,i)); i?ctx.lineTo(x,y):ctx.moveTo(x,y); } ctx.stroke(); ctx.restore();
    }

    // --- ปรับให้รับ timestamp ได้ เพื่อใช้ค่า at จาก /data และ /history ---
    function pushPoint(temp, hum, ts = Date.now()){
      series.t.push(Number(temp));
      series.h.push(Number(hum));
      series.ts.push(Number(ts));
      if(series.t.length > MAX_POINTS){ series.t.shift(); series.h.shift(); series.ts.shift(); }
      scheduleAnimation();
    }

    // โหลดประวัติจาก MongoDB แล้วเติมลงกราฟ + ตาราง
    async function loadHistory(limit = 120){
      try{
        const res = await fetch(`${BACKEND_BASE}/history?limit=${limit}`, { cache: "no-store" });
        const docs = await res.json();
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = '';

        // เติมลงกราฟก่อน
        docs.forEach(d => {
          const ts = new Date(d.at).getTime();
          pushPoint(d.temperature, d.humidity, ts);
        });

        // แสดงเป็นตาราง (ล่าสุดอยู่ล่างสุดตามเวลา)
        docs.forEach(d => {
          const tr = document.createElement('tr');
          const tStr = new Date(d.at).toLocaleString('th-TH', { hour12:false });
          tr.innerHTML = `
            <td>${tStr}</td>
            <td>${Number(d.temperature).toFixed(1)}</td>
            <td>${Number(d.humidity).toFixed(0)}</td>
          `;
          tbody.appendChild(tr);
        });
      }catch(e){
        console.error('loadHistory error:', e);
      }
    }

    async function fetchData(){
      try{
        const res = await fetch(`${BACKEND_BASE}/data`, { cache: "no-store" });
        const data = await res.json();

        if (data.temperature !== null){
          const t = Number(data.temperature);
          setText("temperature-value", t.toFixed(1));
          if(!isNaN(t) && data.humidity !== null){
            const ts = data.at ?? Date.now(); // ใช้เวลา at จาก backend ถ้ามี
            pushPoint(t, Number(data.humidity), ts);
          }
        }
        if (data.humidity !== null){
          const h = Number(data.humidity);
          setText("humidity-value", `${h.toFixed(0)}%`);
          const donut = document.getElementById('humidity-donut');
          if (donut) donut.style.setProperty('--p', Math.max(0, Math.min(100, h)));
        }
        setText("status-message", "Data updated ✅");
      }catch(err){
        console.error("Fetch error:", err);
        setText("status-message", "Error fetching data ⚠️");
      }
    }

    // โหลดประวัติก่อน แล้วค่อยเริ่มดึงปัจจุบันตามปกติ
    loadHistory(120).finally(() => {
      fetchData();
      setInterval(fetchData, 5000);
    });
  </script>
</body>
</html>
