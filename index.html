<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Temperature & Humidity Monitor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0f2235;         /* พื้นหลังไล่เฉดตามภาพ */
      --bg2:#3c5570;
      --bg3:#a9b6c4;
      --text:#f3f7fd;
      --muted:rgba(255,255,255,.85);

      --panel:rgba(255,255,255,.12);
      --panel-2:rgba(255,255,255,.16);
      --panel-card:#eef1f5; /* สีพื้นใน card อ่อน ๆ */
      --panel-tint:rgba(0,0,0,.06);

      --border:rgba(255,255,255,.24);
      --card-border:rgba(0,0,0,.08);
      --shadow:0 28px 60px rgba(8,18,32,.35);

      --lineT:#ffb870;  /* เส้นอุณหภูมิ */
      --lineH:#7db9ff;  /* เส้นความชื้น */
      --grid:rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family:'Poppins',system-ui,Segoe UI,Arial,sans-serif;
      background:
        radial-gradient(1200px 900px at 100% -10%, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 55%, var(--bg3) 100%);
      display:flex; align-items:center; justify-content:center; padding:28px;
    }

    .board{
      width:min(1080px,96vw);
      border-radius:28px; background:rgba(255,255,255,.10);
      backdrop-filter: blur(18px) saturate(125%); -webkit-backdrop-filter: blur(18px) saturate(125%);
      border:1px solid var(--border); box-shadow:var(--shadow); overflow:hidden; position:relative;
    }
    .bar{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 22px; border-bottom:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0));
    }
    .place{font-weight:800; font-size:26px; letter-spacing:.2px; text-shadow:0 1px 0 rgba(0,0,0,.28)}
    .chip{
      font-size:14px; font-weight:700; color:#1c2d45;
      background:#ffffff; border:1px solid rgba(0,0,0,.06);
      padding:8px 14px; border-radius:999px; box-shadow:0 10px 18px rgba(0,0,0,.18);
    }

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; padding:18px;}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, #ffffff, #f0f3f7);
      border:1px solid var(--card-border);
      border-radius:22px; box-shadow:0 12px 28px rgba(0,0,0,.16);
      padding:22px;
    }

    /* แผงซ้าย (อุณหภูมิ) */
    .main{
      display:grid; grid-template-columns:88px 1fr; gap:18px; align-items:center;
    }
    .icon{
      width:72px;height:72px;border-radius:18px;
      display:flex;align-items:center;justify-content:center;font-size:38px;
      background:linear-gradient(180deg, #fff4cf, #ffe39a);
      border:1px solid rgba(0,0,0,.06);
      box-shadow: inset 0 10px 20px rgba(255,255,255,.65), 0 6px 16px rgba(0,0,0,.18);
      color:#e7b100;
    }
    .tempRow{display:flex;align-items:baseline;gap:10px}
    #temperature-value{
      font-size: clamp(44px, 9vw, 88px); line-height:1; font-weight:800;
      color:#2b3c54; letter-spacing:.5px; text-shadow:0 2px 0 rgba(0,0,0,.10);
    }
    .unit{font-weight:700;color:#5f738f}
    .subtext{margin-top:2px;color:#5f738f;font-weight:700}

    /* แผงขวา (ความชื้น) */
    .side{display:flex;flex-direction:column;gap:18px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .label{font-weight:800;color:#2b3c54;display:flex;align-items:center;gap:8px}

    .donut{
      --p:0; width:128px; height:128px; border-radius:50%;
      background:
        conic-gradient(var(--lineH) calc(var(--p)*1%), #e3e9f1 0),
        radial-gradient(closest-side, #ffffff 72%, transparent 74%, transparent 100%);
      border:1px solid rgba(0,0,0,.06);
      display:flex;align-items:center;justify-content:center;
      box-shadow: inset 0 10px 24px rgba(255,255,255,.6), 0 8px 18px rgba(0,0,0,.12);
      transition: background .7s cubic-bezier(.2,.7,.2,1);
      position:relative;
    }
    .donut:after{
      content:""; position:absolute; inset:12px; border-radius:50%;
      background:linear-gradient(180deg,#ffffff,#eef2f7);
      border:1px solid rgba(0,0,0,.04);
    }
    .donut .num{position:relative;font-size:34px;font-weight:800;color:#2b3c54}

    /* กราฟด้านล่าง */
    .chart-panel{grid-column:1 / -1;}
    .chart-card{position:relative; overflow:hidden}
    .legend{
      position:absolute; top:12px; right:14px; display:flex; gap:10px;
      font-size:12px; color:#5f738f; font-weight:700;
      background:#e6ebf2; border:1px solid rgba(0,0,0,.06);
      border-radius:999px; padding:6px 10px; box-shadow:0 6px 14px rgba(0,0,0,.08);
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .t{background:var(--lineT)}
    .h{background:var(--lineH)}
    canvas{width:100%; height:320px; display:block}

    /* ปุ่มสถานะ */
    .status-wrap{display:flex; justify-content:center; margin-top:14px}
    #status-message{
      color:#2b3c54; background:#ffffff; border:1px solid rgba(0,0,0,.06);
      border-radius:999px; padding:10px 18px; font-weight:800;
      box-shadow:0 10px 20px rgba(0,0,0,.12);
    }
  </style>
</head>
<body>
  <div class="board">
    <div class="bar">
      <div class="place">Bangkok</div>
      <!-- ถ้าอยากใช้เวลาจริง: ใส่ id="clock" และ uncomment โค้ด JS ด้านล่าง -->
      <div class="chip">24 ชม.</div>
    </div>

    <div class="grid">
      <!-- ซ้าย: อุณหภูมิ -->
      <section class="card main">
        <div class="icon">☀️</div>
        <div>
          <div class="tempRow">
            <div id="temperature-value">--</div>
            <div class="unit">°C</div>
          </div>
          <div class="subtext">อุณหภูมิ</div>
        </div>
      </section>

      <!-- ขวา: ความชื้น + สถานะ -->
      <section class="side">
        <div class="card">
          <div class="row">
            <div class="label">ความชื้นสัมพัทธ์</div>
            <div class="donut" id="humidity-donut" style="--p:0">
              <span class="num" id="humidity-value">--%</span>
            </div>
          </div>
        </div>

        <div class="card status-wrap">
          <div id="status-message">Connecting...</div>
        </div>
      </section>

      <!-- ล่าง: กราฟ -->
      <section class="card chart-panel chart-card">
        <div class="legend">
          <span style="display:flex;align-items:center;gap:6px"><span class="dot t"></span>Temp</span>
          <span style="display:flex;align-items:center;gap:6px"><span class="dot h"></span>Humidity</span>
        </div>
        <canvas id="chart"></canvas>
      </section>
    </div>
  </div>

  <script>
    /* ============ ดึงข้อมูล & กราฟ: คงโครงสร้างเดิม ============ */
    const BACKEND_BASE = "https://dht11-2gtd.onrender.com";

    function setText(id, value){
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    /* ประวัติข้อมูลสำหรับกราฟ */
    const MAX_POINTS = 60; // ~5 นาทีถ้า poll ทุก 5 วิ
    const series = { t: [], h: [], ts: [] };

    // Canvas
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    let dpi = 1;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      dpi = window.devicePixelRatio || 1;
      canvas.width = Math.round(rect.width * dpi);
      canvas.height = Math.round(rect.height * dpi);
      drawChart(1);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function lerp(a,b,t){ return a + (b-a)*t; }
    function niceRange(min, max){
      if (min === max) { min -= 1; max += 1; }
      const pad = (max - min) * 0.15;
      return [Math.floor(min - pad), Math.ceil(max + pad)];
    }

    // animation buffer
    let anim = { fromT:[], toT:[], fromH:[], toH:[], start:0, dur:800 };
    function scheduleAnimation() {
      anim.fromT = anim.toT.slice();
      anim.fromH = anim.toH.slice();
      anim.toT   = series.t.slice();
      anim.toH   = series.h.slice();
      anim.start = performance.now();
      requestAnimationFrame(tick);
    }
    function tick(now){
      const p = Math.min(1, (now - anim.start)/anim.dur);
      drawChart(p);
      if (p < 1) requestAnimationFrame(tick);
    }

    function drawChart(progress=1){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // grid เส้นบางเทาอ่อน
      ctx.save();
      ctx.strokeStyle = 'rgba(0,0,0,.10)';
      ctx.lineWidth = 1 * dpi;
      const gx = 8, gy = 5;
      for(let i=1;i<gx;i++){
        const x = (w/gx)*i;
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      for(let i=1;i<gy;i++){
        const y = (h/gy)*i;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.restore();

      if (series.t.length < 2) return;

      const minT = Math.min(...series.t), maxT = Math.max(...series.t);
      const minH = Math.min(...series.h), maxH = Math.max(...series.h);
      const [yMinT,yMaxT] = niceRange(minT, maxT);
      const [yMinH,yMaxH] = niceRange(minH, maxH);

      const N = series.t.length;
      const pad = 18 * dpi;
      const plotW = w - pad*2;
      const plotH = h - pad*2;
      const xAt = i => pad + (i/(N-1))*plotW;
      const yAtT = v => pad + (1 - (v - yMinT)/(yMaxT - yMinT))*plotH;
      const yAtH = v => pad + (1 - (v - yMinH)/(yMaxH - yMinH))*plotH;

      const sample = (arrFrom, arrTo, i) => lerp(arrFrom[i] ?? arrTo[i], arrTo[i], progress);

      // temp line (ส้ม)
      ctx.save();
      ctx.lineWidth = 3 * dpi;
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--lineT').trim();
      ctx.beginPath();
      for (let i=0;i<N;i++){
        const x = xAt(i);
        const y = yAtT(sample(anim.fromT, anim.toT, i));
        i? ctx.lineTo(x,y) : ctx.moveTo(x,y);
      }
      ctx.stroke();
      ctx.restore();

      // humidity line (ฟ้า)
      ctx.save();
      ctx.lineWidth = 3 * dpi;
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--lineH').trim();
      ctx.beginPath();
      for (let i=0;i<N;i++){
        const x = xAt(i);
        const y = yAtH(sample(anim.fromH, anim.toH, i));
        i? ctx.lineTo(x,y) : ctx.moveTo(x,y);
      }
      ctx.stroke();
      ctx.restore();
    }

    // อัปเดตรายการ
    function pushPoint(temp, hum){
      const now = Date.now();
      series.t.push(Number(temp));
      series.h.push(Number(hum));
      series.ts.push(now);
      if (series.t.length > MAX_POINTS){
        series.t.shift(); series.h.shift(); series.ts.shift();
      }
      scheduleAnimation();
    }

    // polling ข้อมูล
    async function fetchData() {
      try {
        const res = await fetch(`${BACKEND_BASE}/data`, { cache: "no-store" });
        const data = await res.json();

        if (data.temperature !== null) {
          const t = Number(data.temperature);
          setText("temperature-value", t.toFixed(1));
          if (!isNaN(t) && data.humidity !== null) {
            pushPoint(t, Number(data.humidity));
          }
        }
        if (data.humidity !== null) {
          const h = Number(data.humidity);
          setText("humidity-value", `${h.toFixed(0)}%`);
          const donut = document.getElementById('humidity-donut');
          if (donut) donut.style.setProperty('--p', Math.max(0, Math.min(100, h)));
        }
        setText("status-message", "Data updated ✅");
      } catch (err) {
        console.error("Fetch error:", err);
        setText("status-message", "Error fetching data ⚠️");
      }
    }

    fetchData();
    setInterval(fetchData, 5000);

    /* ============ เปิดใช้หากต้องการนาฬิกาเรียลไทม์บน chip ============ */
    // function updateClock(){
    //   const el = document.getElementById('clock');
    //   if (!el) return;
    //   const now = new Date();
    //   el.textContent = now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
    // }
    // updateClock();
    // setInterval(updateClock, 1000);
  </script>
</body>
</html>
